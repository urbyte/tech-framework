### 互联网注册中心设计与实践

> 注册中心是AP模型，可用性
>
> 分布式锁是CP模型，一致性

#### zookeeper

##### 功能

* 文件系统
* 通知机制

##### 分布式程序协调服务

* 节点选主
* 配置管理
* 粗粒度分布式锁
* 主备高可用切换
* 服务注册
* 服务发现

##### 注册中心本质

* 查询
  * 服务名称查询参数
  * 查询服务可用的ip和端口列表
* 对数据一致性要求不高，最终一致性
  * 不一致的影响：节点流量不均衡

##### zookeeper作为注册中心缺点

* zookeeper集群发生网络分区时，同机房的服务不可调用，因为zookeeper注册中心自身为保脑裂下的数据一致性而放弃可用性。zookeeper是cp模型

* 互联网微服务规模剧增情况下：
  * 服务规模超过一定数量，zookeeper将会不堪重负
  * 服务发布大量注册写请求
  * 毫秒级服务健康状态的写请求
  * 服务与注册中心海量长连接
  * zookeeper写节点是单点，不能水平扩展，解决方法：
    * 按照业务功能垂直拆分为不同zk集群，这样会破坏不同业务的服务连通性，同时业务整合连通不可预知。比如：商品注册中心、交易注册中心、搜索注册中心、推荐注册中心，假如搜索和推荐业务合并就很麻烦，合并导致大量服务的写请求。
  * 不需要存储（zookeeper为了一致性存储了以下信息）
    * 核心数据：实时健康的服务列表
    * zab协议对每个写请求在节点上保持写一个事务日志
    * 定期将内存数据镜像dump到磁盘，保持数据一致性和持久性
    * 调用方并不关心服务的历史地址列表、过去的健康状态
  * 需要存储
    * 服务的元数据信息
      * 服务的版本、分组、所在机房、权重、鉴权策略信息、服务标签等元信息
  * 探活机制，利用zookeeper的session活性跟踪机制以及节点特性，存在问题：
    * 服务健康情况无法真正探测
    * 服务假死问题

##### 注册中心容灾

> 注册中心不能因为自身的任何原因破坏服务之间本身的可连通性

* 服务调用链路需要弱依赖注册中心，只有服务发布、机器上下线、服务扩容缩容等才强依赖
* 客户端设计考虑容灾
  * 缓存数据机制
  * zk节点宕机，应用服务是否正常work
  * 原生zk客户端并不具有，curater比原生（zkclient）好

##### zookeeper适用场景

* 适用场景：大数据、分布式协调
* 不适用场景：大规模交易(交付)、大规模服务发现

























































